<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Handwriting to Text</title>
  <style>
    body {
      font-family: system-ui, sans-serif;
      max-width: 700px;
      margin: 1.5rem auto;
      padding: 1rem;
    }

    .box {
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 1rem;
      margin-top: 1rem;
      box-sizing: border-box;
    }

    #preview {
      max-width: 100%;
      max-height: 280px;
      display: none;
      margin-top: 0.5rem;
    }

    #progress {
      margin-top: 0.5rem;
      font-size: 0.9rem;
      color: #555;
    }

    textarea {
      width: 100%;
      min-height: 150px;
      resize: vertical;
      box-sizing: border-box;
    }

    button {
      padding: 0.6rem 1rem;
      border-radius: 4px;
      border: none;
      background: #1a73e8;
      color: white;
      cursor: pointer;
    }

    button:disabled {
      opacity: 0.6;
      cursor: default;
    }

    @media (max-width: 600px) {
      body {
        margin: 0.5rem auto;
        padding: 0.75rem;
      }

      h2 {
        font-size: 1.3rem;
      }

      textarea {
        min-height: 120px;
      }

      button {
        width: 100%;
      }

      #preview {
        max-height: 200px;
      }
    }
  </style>
</head>
<body>
  <h2>Handwritten Image to Text</h2>
  <p>This tool sends your image to a secure Python backend that uses Google Cloud Vision and an AI language model to clean up the recognized text.</p>
  <p>Use clear, well-lit photos of handwritten notes for best results.</p>

  <div class="box">
    <input type="file" id="fileInput" accept="image/*" />
    <br />
    <img id="preview" alt="Image preview" />
    <div id="progress"></div>
    <br />
    <button id="startBtn" disabled>Recognize Text</button>
  </div>

  <div class="box">
    <h3>Recognized Text</h3>
    <textarea id="output" placeholder="Text will appear here..." readonly></textarea>
  </div>

  <script>
    const BACKEND_URL = 'https://handwriting-to-text-production.up.railway.app';

    const fileInput = document.getElementById('fileInput');
    const preview = document.getElementById('preview');
    const startBtn = document.getElementById('startBtn');
    const progressEl = document.getElementById('progress');
    const output = document.getElementById('output');

    let imageFile = null;

    fileInput.addEventListener('change', () => {
      const file = fileInput.files[0];
      if (!file) return;
      imageFile = file;

      // Show preview
      const reader = new FileReader();
      reader.onload = e => {
        preview.src = e.target.result;
        preview.style.display = 'block';
      };
      reader.readAsDataURL(file);

      startBtn.disabled = false;
      progressEl.textContent = '';
      output.value = '';
    });

    startBtn.addEventListener('click', async () => {
      if (!imageFile) return;

      startBtn.disabled = true;
      progressEl.textContent = 'Uploading image...';
      output.value = '';

      const formData = new FormData();
      formData.append('file', imageFile, imageFile.name || 'upload.jpg');

      try {
        const response = await fetch(`${BACKEND_URL}/ocr`, {
          method: 'POST',
          body: formData,
        });

        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(`Server error: ${response.status} ${errorText}`);
        }

        const data = await response.json();
        output.value = (data.text || '').trim();
        const usedLlm = data.used_llm === true;
        progressEl.textContent = usedLlm ? 'Done (AI cleanup applied).' : 'Done.';
      } catch (err) {
        console.error(err);
        progressEl.textContent = 'Error during recognition.';
        output.value = 'An error occurred. Please try another image.';
      } finally {
        startBtn.disabled = false;
      }
    });
  </script>
</body>
</html>
